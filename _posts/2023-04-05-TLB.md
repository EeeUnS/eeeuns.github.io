---
layout: post
title: "TLB"
date:   2023-04-05 19:26:01 +0900
tag: cs
---

# TLB

책에서도 많이 다루는 TLB 작동방식을 통해 가상 메모리를 어떻게 물리 메모리로 바꾸는 과정들은 이미 많은 글들이 있다.

![Untitled](/images/TLB/Untitled.png)

![Untitled](/images/TLB/Untitled%201.png)

국룰 그림 놓고 시작.

가상주소는 48byte만 사용한다. (amd64한정)

여기서 의문점이 생겼다. 

**다른 프로세스간 같은 가상 주소를 어떻게 각각의 다른 물리메모리로 매핑하는가???**

이하 내용은

windows, x64(amd64)에서 한정한다.

# 미스 처리

TLB 에서 미스가 나면 page table을 자동으로 탐색한다.

라고만 되어있겠지만 이 탐색 과정을 좀 더 자세히 살펴보자.

![Untitled](/images/TLB/Untitled%202.png)

X86은 CR 이라는 레지스터가 존재하는데 컨트롤 레지스터라 부른다.

![Untitled](/images/TLB/Untitled%203.png)

PCID 는 12비트 식별자고 CR4(17번째 비트) PCIDE flag가 세팅되어있으면 CR3 11:0 에 할당된다.

상위 비트는 PML4 테이블( PAGE MAP LEVEL 4**)** 이 된다. 

![Untitled](/images/TLB/Untitled%204.png)

개략적인 물리메모리 접근하는 구조

# switcing 시의 TLB

context switching할때 TLB는 어떻게 처리해야하는가?

TLB를 냅둔다면 같은 가상 주소공간을 접근한다면 다른 프로세스의 물리메모리를 접근할거다.

첫번째로 할 수 있는건 TLB flush 하는거다

멜트다운 취약점이 드러난 당시 긴급한 패치 방법으로 TLB를 전체 flush시키는 식으로 처리를 했는데 이러면서 나온 성능하락이 굉장히 컸다.

그래서 그나마의 대안인 방법이 TLB에서 CR3의 PCID 값을 연관지어 처리하는 것이다. TLB내부에서 구분지어서 사용할 수 있다. 이 부분은 하드웨어의 지원이 있어야했다.

이러면 TLB를 전체를 flush시키지 않더라도 pcid간 영역을 구분짓거나 적은 범위만큼만 flush해서 사용할 수 있다 


# page table 은 swap out되는가?

nonpaged pool인가?

nonpage pool 이라고 할 수도있는데 애초에 page table은 memory pool영역이 아니라 nonpage/page 그 어느 영역에도 속하지 않는다고 봐야한다  

아무래도 전체를 다보는건 힘들어서 4.10만 잠깐봤는데  intel 메뉴얼 4챕 paging 파일을 전체적으로 다 봐야 이해할 수 있을 듯하다..



- [https://www.intel.com/content/dam/www/public/us/en/documents/manuals/64-ia-32-architectures-software-developer-vol-3a-part-1-manual.pdf](https://www.intel.com/content/dam/www/public/us/en/documents/manuals/64-ia-32-architectures-software-developer-vol-3a-part-1-manual.pdf)

- [https://en.wikipedia.org/wiki/Control_register](https://en.wikipedia.org/wiki/Control_register)

- [https://42osstudy.github.io/os-study/jekyll/2022-08-05-ch21.html](https://42osstudy.github.io/os-study/jekyll/2022-08-05-ch21.html)

- [https://en.wikipedia.org/wiki/Translation_lookaside_buffer](https://en.wikipedia.org/wiki/Translation_lookaside_buffer)

- [https://shhoya.github.io/hv_paging.html#--4-level-paging-and-5-level-paging](https://shhoya.github.io/hv_paging.html#--4-level-paging-and-5-level-paging)

- [http://recipes.egloos.com/5232056](http://recipes.egloos.com/5232056)

- [https://techcommunity.microsoft.com/t5/windows-blog-archive/pushing-the-limits-of-windows-paged-and-nonpaged-pool/ba-p/723789](https://techcommunity.microsoft.com/t5/windows-blog-archive/pushing-the-limits-of-windows-paged-and-nonpaged-pool/ba-p/723789)

- [https://connormcgarr.github.io/paging/](https://connormcgarr.github.io/paging/)